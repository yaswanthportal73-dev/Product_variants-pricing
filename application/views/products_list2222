<!DOCTYPE html>
<html lang="en">
<head>
    <?php $this->load->view('partials/title-meta'); ?>
    <?php $this->load->view('partials/head-css'); ?>

    <!-- Required CSS -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>

    <style>
        .product-img { width: 50px; height: 50px; object-fit: cover; border-radius: 4px; cursor: pointer; }
        .low-stock { color: #dc3545; font-weight: bold; }
        .out-of-stock { color: #6c757d; font-weight: bold; }
        .status-active { color: #28a745; }
        .status-inactive { color: #dc3545; }
        .variant-row { background-color: #f8f9fa !important; }
        .variant-table td { padding: 0.5rem 0.75rem !important; }
        .toggle-variants {
            cursor: pointer;
            width: 24px; height: 24px;
            display: inline-flex; align-items: center; justify-content: center;
            color: #6c757d; border-radius: 4px;
        }
        .toggle-variants:hover { color: #0d6efd; background-color: #e9ecef; }
        .s-no { font-weight: 500; text-align: center; width: 5%; }
        .no-expand { color: #adb5bd; }
        .expand-icon { transition: transform 0.3s; }
        .expanded { transform: rotate(90deg); }

        /* Modal styling */
        .modal-lg { max-width: 95%; }
        .image-upload { border:2px dashed #ddd; border-radius:10px; padding:40px; text-align:center; cursor:pointer; transition:all .3s; }
        .image-upload:hover { border-color:#007bff; background:#f8f9fa; }
        .image-uploads i { font-size:48px; color:#007bff; margin-bottom:15px; }
        .image-preview { display:flex; flex-wrap:wrap; gap:15px; margin-top:20px; }
        .image-preview-item { position:relative; width:120px; height:120px; border-radius:8px; overflow:hidden; border:1px solid #ddd; }
        .image-preview-item img { width:100%; height:100%; object-fit:cover; }
        .btn-remove {
            position:absolute; top:5px; right:5px; width:30px; height:30px; border-radius:50%;
            background:#dc3545; color:white; border:none; cursor:pointer;
            display:flex; align-items:center; justify-content:center; opacity:.8;
        }
        .btn-remove:hover { opacity:1; }
        #barcodePreview { min-height:150px; display:flex; align-items:center; justify-content:center; 
                          border:1px solid #dee2e6; border-radius:5px; padding:20px; background:white; }
    </style>
</head>

<body>
    <?php $this->load->view('partials/body'); ?>
    <div class="main-wrapper">
        <?php $this->load->view('partials/menu'); ?>
        <div class="page-wrapper">
            <div class="content">

                <!-- Page Header -->
                <div class="page-header">
                    <div class="add-item d-flex">
                        <div class="page-title">
                            <h4>Products List</h4>
                            <h6>Manage your products & variants</h6>
                        </div>
                    </div>
                    <ul class="table-top-head">
                        <li>
                            <div class="page-btn">
                                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addProductModal">
                                    <i data-feather="plus" class="me-2"></i>Add New Product
                                </button>
                            </div>
                        </li>
                    </ul>
                </div>

                <!-- Stats Cards -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card stats-card text-center shadow-sm">
                            <div class="card-body">
                                <h6 class="text-muted">Total Products</h6>
                                <h3><?php echo $total_products ?? 0; ?></h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stats-card text-center shadow-sm border-warning">
                            <div class="card-body">
                                <h6 class="text-warning">Low Stock</h6>
                                <h3 class="text-warning"><?php echo $low_stock ?? 0; ?></h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stats-card text-center shadow-sm border-danger">
                            <div class="card-body">
                                <h6 class="text-danger">Out of Stock</h6>
                                <h3 class="text-danger"><?php echo $out_of_stock ?? 0; ?></h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stats-card text-center shadow-sm border-info">
                            <div class="card-body">
                                <h6 class="text-info">Total Variants</h6>
                                <h3 class="text-info"><?php echo $total_variants ?? 0; ?></h3>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Alerts -->
                <?php if($this->session->flashdata('success')): ?>
                <div class="alert alert-success alert-dismissible fade show">
                    <?php echo $this->session->flashdata('success'); ?>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
                <?php endif; ?>
                <?php if($this->session->flashdata('error')): ?>
                <div class="alert alert-danger alert-dismissible fade show">
                    <?php echo $this->session->flashdata('error'); ?>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
                <?php endif; ?>

                <!-- Search -->
                <div class="card mb-4">
                    <div class="card-body">
                        <form method="get" action="<?php echo base_url('products'); ?>">
                            <div class="row g-3">
                                <div class="col-md-8">
                                    <div class="input-group">
                                        <input type="text" class="form-control" name="search"
                                            placeholder="Search by name, barcode, category..."
                                            value="<?php echo htmlspecialchars($search ?? ''); ?>">
                                        <button class="btn btn-primary" type="submit">
                                            <i data-feather="search"></i> Search
                                        </button>
                                        <?php if(!empty($search)): ?>
                                        <a href="<?php echo base_url('products'); ?>" class="btn btn-secondary">Clear</a>
                                        <?php endif; ?>
                                    </div>
                                </div>
                                <div class="col-md-4 text-end">
                                    <span class="text-muted">Showing: <?php echo count($products); ?> of <?php echo $total_products ?? 0; ?> products</span>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Products Table -->
                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover table-bordered align-middle">
                                <thead class="table-dark">
                                    <tr>
                                        <th width="5%" class="text-center">S.No</th>
                                        <th width="4%" class="text-center"><span title="Variants">V</span></th>
                                        <th width="8%">Image</th>
                                        <th>Product Name</th>
                                        <th>Barcode</th>
                                        <th>Category → Sub</th>
                                        <th width="10%">Stock</th>
                                        <th width="10%">Status</th>
                                        <th width="12%">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <?php if(empty($products)): ?>
                                    <tr><td colspan="9" class="text-center py-4">No products found.</td></tr>
                                    <?php else:
                                        $base = $this->uri->segment(2) ? ($this->uri->segment(2) - 1) * 20 : 0;
                                        $sno = $base + 1;
                                        foreach($products as $product): ?>
                                    <tr>
                                        <td class="text-center s-no"><?php echo $sno++; ?></td>
                                        <td class="text-center">
                                            <?php if (!empty($product->variants)): ?>
                                            <span class="toggle-variants" data-product-id="<?php echo $product->id; ?>" 
                                                  title="View <?php echo count($product->variants); ?> variant(s)">
                                                <i data-feather="chevron-right" class="expand-icon"></i>
                                            </span>
                                            <?php else: ?>
                                            <span class="no-expand" title="No variants">—</span>
                                            <?php endif; ?>
                                        </td>
                                        <td class="text-center">
                                            <?php
                                            $img_path = !empty($product->primary_image)
                                                ? base_url("uploads/products/{$product->id}/{$product->primary_image}")
                                                : base_url('assets/img/default-product.png');
                                            ?>
                                            <img src="<?php echo $img_path; ?>" class="product-img"
                                                 onerror="this.src='<?php echo base_url('assets/img/default-product.png'); ?>'">
                                        </td>
                                        <td><strong><?php echo htmlspecialchars($product->name); ?></strong></td>
                                        <td><code><?php echo htmlspecialchars($product->barcode); ?></code></td>
                                        <td>
                                            <?php echo htmlspecialchars($product->category_name ?? '—'); ?>
                                            <?php if(!empty($product->sub_category_name)): ?>
                                            <br><small class="text-muted">→ <?php echo htmlspecialchars($product->sub_category_name); ?></small>
                                            <?php endif; ?>
                                        </td>
                                        <td class="text-center">
                                            <?php $total_stock = $product->total_stock ?? 0; ?>
                                            <?php if($total_stock == 0): ?>
                                                <span class="out-of-stock">Out</span>
                                            <?php elseif($total_stock <= ($product->alert_quantity ?? 5)): ?>
                                                <span class="low-stock"><?php echo $total_stock; ?> Low</span>
                                            <?php else: ?>
                                                <span class="text-success"><?php echo $total_stock; ?></span>
                                            <?php endif; ?>
                                        </td>
                                        <td class="text-center">
                                            <?php if($product->status == 1): ?>
                                                <span class="status-active">Active</span>
                                            <?php else: ?>
                                                <span class="status-inactive">Inactive</span>
                                            <?php endif; ?>
                                        </td>
                                        <td class="text-center">
                                            <div class="d-flex justify-content-center gap-1">
                                                <a href="javascript:void(0)" class="btn btn-info btn-sm view-btn" 
                                                   data-id="<?php echo $product->id; ?>" title="View">
                                                    <i data-feather="eye"></i>
                                                </a>
                                                <a href="javascript:void(0)" class="btn btn-warning btn-sm edit-btn" 
                                                   data-id="<?php echo $product->id; ?>" title="Edit">
                                                    <i data-feather="edit-2"></i>
                                                </a>
                                                <a href="javascript:void(0)" class="btn btn-danger btn-sm delete-btn" 
                                                   data-id="<?php echo $product->id; ?>" title="Delete">
                                                    <i data-feather="trash-2"></i>
                                                </a>
                                            </div>
                                        </td>
                                    </tr>

                                    <!-- Variant Row (Hidden by default) -->
                                    <?php if (!empty($product->variants)): ?>
                                    <tr class="variant-row d-none" id="variants-<?php echo $product->id; ?>">
                                        <td colspan="9" class="p-0">
                                            <div class="px-3 py-2 bg-light">
                                                <h6 class="mb-3">
                                                    <i data-feather="layers" class="me-1"></i>
                                                    Variants for <strong>"<?php echo htmlspecialchars($product->name); ?>"</strong>
                                                    <span class="badge bg-primary ms-2"><?php echo count($product->variants); ?> variants</span>
                                                </h6>
                                                <div class="table-responsive">
                                                    <table class="table table-sm variant-table">
                                                        <thead class="table-light">
                                                            <tr>
                                                                <th>Unit</th>
                                                                <th>Volume</th>
                                                                <th>Purchase Price</th>
                                                                <th>Selling Price</th>
                                                                <th>Discount</th>
                                                                <th>Stock</th>
                                                                <th>Status</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            <?php foreach($product->variants as $v): ?>
                                                            <tr>
                                                                <td>
                                                                    <span class="badge badge-variant bg-secondary"><?php echo htmlspecialchars($v->unit_name); ?></span>
                                                                    <?php if(!empty($v->volume) && $v->volume != 1): ?>
                                                                    <br><small><?php echo $v->volume; ?>x</small>
                                                                    <?php endif; ?>
                                                                </td>
                                                                <td><?php echo $v->volume ?? 1; ?></td>
                                                                <td>₹<?php echo number_format($v->purchase_price, 2); ?></td>
                                                                <td>₹<?php echo number_format($v->selling_price, 2); ?></td>
                                                                <td>
                                                                    <?php if($v->discount > 0): ?>
                                                                    <span class="text-success">₹<?php echo number_format($v->discount, 2); ?></span>
                                                                    <?php else: ?>
                                                                    <span class="text-muted">—</span>
                                                                    <?php endif; ?>
                                                                </td>
                                                                <td>
                                                                    <?php if($v->stock == 0): ?>
                                                                        <span class="out-of-stock">Out</span>
                                                                    <?php elseif($v->stock <= $v->alert_qty): ?>
                                                                        <span class="low-stock"><?php echo $v->stock; ?></span>
                                                                    <?php else: ?>
                                                                        <span class="text-success"><?php echo $v->stock; ?></span>
                                                                    <?php endif; ?>
                                                                </td>
                                                                <td><?php echo $v->status ? '✓' : '✗'; ?></td>
                                                            </tr>
                                                            <?php endforeach; ?>
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                    <?php endif; ?>
                                    <?php endforeach; endif; ?>
                                </tbody>
                            </table>
                        </div>

                        <!-- Pagination -->
                        <?php if(isset($links)): ?>
                        <div class="mt-3 d-flex justify-content-center">
                            <?php echo $links; ?>
                        </div>
                        <?php endif; ?>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== ADD PRODUCT MODAL ========== -->
    <div class="modal fade" id="addProductModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Product</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="addProductForm" enctype="multipart/form-data">
                    <input type="hidden" name="<?= $this->security->get_csrf_token_name(); ?>" 
                           value="<?= $this->security->get_csrf_hash(); ?>" id="csrf-token">
                    <div class="modal-body">
                        <!-- Product Info -->
                        <div class="card mb-3">
                            <div class="card-header"><h6>Product Information</h6></div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <label>Product Name *</label>
                                        <input type="text" name="name" class="form-control" required maxlength="255">
                                    </div>
                                    <div class="col-md-3">
                                        <label>Barcode Type</label>
                                        <div class="form-control bg-light">EAN-13</div>
                                    </div>
                                    <div class="col-md-3">
                                        <label>EAN-13 Barcode *</label>
                                        <div class="input-group">
                                            <input type="text" name="barcode" class="form-control" pattern="\d{13}" maxlength="13" id="modalBarcodeInput">
                                            <button type="button" class="btn btn-outline-primary" onclick="generateModalBarcode()">Generate</button>
                                        </div>
                                        <div id="modalBarcodePreview" class="mt-2" style="min-height:100px;"></div>
                                    </div>
                                </div>
                                <div class="row mt-2">
                                    <div class="col-md-4">
                                        <label>Category *</label>
                                        <select class="form-control select2" name="category_id" id="modalCategorySelect" required>
                                            <option value="">Choose Category</option>
                                            <?php foreach($categories as $c): ?>
                                            <option value="<?php echo $c->id ?>"><?php echo $c->name ?></option>
                                            <?php endforeach; ?>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label>Sub Category</label>
                                        <select class="form-control select2" name="sub_category_id" id="modalSubCategorySelect">
                                            <option value="">Choose Sub Category</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label>Brand</label>
                                        <select class="form-control select2" name="brand_id">
                                            <option value="">Choose Brand</option>
                                            <?php foreach($brands as $b): ?>
                                            <option value="<?php echo $b->id ?>"><?php echo $b->name ?></option>
                                            <?php endforeach; ?>
                                        </select>
                                    </div>
                                </div>
                                <div class="row mt-2">
                                    <div class="col-md-6">
                                        <label>Supplier</label>
                                        <select class="form-control select2" name="supplier_id">
                                            <option value="">Choose Supplier</option>
                                            <?php foreach($suppliers as $s): ?>
                                            <option value="<?php echo $s->id ?>"><?php echo $s->name ?></option>
                                            <?php endforeach; ?>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label>Short Description</label>
                                        <textarea name="short_description" class="form-control" rows="1"></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Variants -->
                        <div class="card mb-3">
                            <div class="card-header"><h6>Pricing & Variants</h6></div>
                            <div class="card-body">
                                <button type="button" class="btn btn-success" onclick="addModalRow()"><i data-feather="plus"></i> Add Variant</button>
                                <table class="table table-bordered mt-2" id="modalPricingTable">
                                    <thead class="table-dark">
                                        <tr><th>Unit</th><th>Volume</th><th>Purchase Price</th><th>Selling Price</th><th>Discount</th><th>Action</th></tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Images -->
                        <div class="card mb-3">
                            <div class="card-header"><h6>Product Images</h6></div>
                            <div class="card-body">
                                <div class="image-upload" onclick="document.getElementById('modalImageUpload').click()">
                                    <input type="file" id="modalImageUpload" name="images[]" multiple accept="image/*" style="display:none;" onchange="previewModalImages(this)">
                                    <div class="image-uploads"><i class="fa fa-plus-circle"></i><h6>Click to upload images</h6></div>
                                </div>
                                <div class="image-preview" id="modalImagePreview"></div>
                            </div>
                        </div>

                        <!-- Status -->
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" name="status" value="1" checked>
                            <label class="form-check-label">Active</label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Product</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <?php $this->load->view('partials/theme-settings'); ?>
    <?php $this->load->view('partials/vendor-scripts'); ?>

    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        let modalUnits = <?php echo json_encode($units); ?>;
        let csrfName = '<?php echo $this->security->get_csrf_token_name(); ?>';

        $(document).ready(function() {
            $('.select2').select2({ width: '100%' });
            feather.replace();

            // Toggle variants
            $('.toggle-variants').on('click', function() {
                const icon = $(this).find('i.expand-icon');
                const id = $(this).data('product-id');
                const row = $('#variants-' + id);
                icon.toggleClass('expanded');
                row.toggleClass('d-none');
            });

            // AJAX: Category → Subcategory
            $('#modalCategorySelect').on('change', function() {
                const catId = $(this).val();
                if (!catId) {
                    $('#modalSubCategorySelect').html('<option value="">Choose Sub Category</option>');
                    return;
                }
                $.post('<?php echo base_url("products/get_sub_categories"); ?>', {
                    category_id: catId,
                    [csrfName]: $('#csrf-token').val()
                }, function(res) {
                    if (res.status === 'success') {
                        let opts = '<option value="">Choose Sub Category</option>';
                        res.data.forEach(c => opts += `<option value="${c.id}">${c.name}</option>`);
                        $('#modalSubCategorySelect').html(opts);
                        $('#csrf-token').val(res[csrfName]);
                    } else {
                        Swal.fire('Error', 'Failed to load subcategories', 'error');
                    }
                }, 'json').fail(() => Swal.fire('Network Error', 'Request failed', 'error'));
            });

            // Add first row in modal
            if ($('#modalPricingTable tbody').length === 0) addModalRow();
        });

        // === MODAL BARCODE ===
        function generateModalBarcode() {
            const firstTwo = Math.floor(Math.random() * 90) + 10;
            const nextTen = Math.floor(Math.random() * 1e10).toString().padStart(10, '0');
            const base = firstTwo + nextTen;
            const check = calculateEAN13CheckDigit(base);
            const code = base + check;
            $('#modalBarcodeInput').val(code);
            updateModalBarcodePreview();
        }

        function calculateEAN13CheckDigit(code) {
            let sum = 0;
            for (let i = 0; i < 12; i++) {
                const d = parseInt(code[i]);
                sum += (i % 2 === 0) ? d : d * 3;
            }
            const r = sum % 10;
            return r === 0 ? 0 : 10 - r;
        }

        function updateModalBarcodePreview() {
            const code = $('#modalBarcodeInput').val();
            const $preview = $('#modalBarcodePreview');
            if (!/^\d{13}$/.test(code)) {
                $preview.html('<small class="text-muted">Enter 13-digit barcode</small>');
                return;
            }
            const canvas = $('<canvas></canvas>')[0];
            $preview.empty().append(canvas);
            try {
                JsBarcode(canvas, code, { format: "EAN13", width: 2, height: 80, displayValue: true });
            } catch (e) {
                $preview.html('<small class="text-danger">Invalid barcode</small>');
            }
        }

        $('#modalBarcodeInput').on('input', updateModalBarcodePreview);

        // === MODAL PRICING ===
        function addModalRow() {
            const tbody = document.querySelector('#modalPricingTable tbody');
            const i = tbody.rows.length;
            let opts = '<option value="">Select Unit</option>';
            modalUnits.forEach(u => opts += `<option value="${u.id}">${u.name} (${u.symbol})</option>`);
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><select name="pricing[${i}][unit_id]" class="form-control" required>${opts}</select></td>
                <td><input type="number" name="pricing[${i}][volume]" class="form-control volume" value="1" min="0.001" step="0.001"></td>
                <td><input type="number" name="pricing[${i}][purchase_price]" class="form-control purchase" value="0" step="0.01"></td>
                <td><input type="number" name="pricing[${i}][selling_price]" class="form-control selling" value="0" step="0.01"></td>
                <td><input type="number" name="pricing[${i}][discount]" class="form-control discount" value="0" step="0.01" readonly></td>
                <td class="text-center"><button type="button" class="btn btn-danger btn-sm" onclick="removeModalRow(this)"><i data-feather="trash-2"></i></button></td>
            `;
            tbody.appendChild(tr);
            feather.replace();
            tr.querySelectorAll('.volume,.purchase,.selling').forEach(el => 
                el.addEventListener('input', () => autoCalculateModal(tr))
            );
        }

        function autoCalculateModal(row) {
            const rows = document.querySelectorAll('#modalPricingTable tbody tr');
            if (rows.length === 0) return;

            const base = rows[0];
            const baseVol = parseFloat(base.querySelector('.volume').value) || 1;
            const basePur = parseFloat(base.querySelector('.purchase').value) || 0;
            const baseSel = parseFloat(base.querySelector('.selling').value) || 0;

            rows.forEach(r => {
                const vol = parseFloat(r.querySelector('.volume').value) || 1;
                const ratio = vol / baseVol;

                const purInput = r.querySelector('.purchase');
                const selInput = r.querySelector('.selling');
                const disInput = r.querySelector('.discount');

                purInput.value = (basePur * ratio).toFixed(2);
                selInput.value = (baseSel * ratio).toFixed(2);
                const discount = (parseFloat(purInput.value) - parseFloat(selInput.value)).toFixed(2);
                disInput.value = discount > 0 ? discount : '0.00';
            });
        }

        function removeModalRow(btn) {
            if (document.querySelectorAll('#modalPricingTable tbody tr').length > 1) {
                btn.closest('tr').remove();
            } else {
                Swal.fire('Warning', 'At least one variant is required.', 'warning');
            }
        }

        // === IMAGE PREVIEW ===
        function previewModalImages(input) {
            const preview = document.getElementById('modalImagePreview');
            if (!input.files.length) return;
            for (let i = 0; i < input.files.length; i++) {
                const file = input.files[i];
                if (file.size > 2 * 1024 * 1024) {
                    Swal.fire('Warning', 'Image too large (>2MB): ' + file.name, 'warning');
                    continue;
                }
                const reader = new FileReader();
                reader.onload = e => {
                    const div = document.createElement('div');
                    div.className = 'image-preview-item';
                    div.innerHTML = `
                        <img src="${e.target.result}">
                        <button type="button" class="btn-remove" onclick="this.parentElement.remove()"><i data-feather="x"></i></button>
                    `;
                    preview.appendChild(div);
                    feather.replace();
                };
                reader.readAsDataURL(file);
            }
        }

        // === FORM SUBMIT (AJAX) ===
        $('#addProductForm').on('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);

            Swal.fire({
                title: 'Saving...',
                text: 'Please wait',
                allowEscapeKey: false,
                allowOutsideClick: false,
                didOpen: () => Swal.showLoading()
            });

            $.ajax({
                url: '<?php echo base_url("products/add_product"); ?>',
                method: 'POST',
                data: formData,
                contentType: false,
                processData: false,
                dataType: 'json',
                success: function(res) {
                    Swal.close();
                    if (res.status === 'success') {
                        Swal.fire('Success', res.message, 'success').then(() => {
                            $('#addProductModal').modal('hide');
                            window.location.reload(); // reload list to show new product
                        });
                    } else {
                        Swal.fire('Error', res.message || 'Validation failed', 'error');
                        $('#csrf-token').val(res[csrfName]);
                    }
                },
                error: function(xhr) {
                    Swal.close();
                    Swal.fire('Error', 'Server error: ' + (xhr.responseJSON?.message || 'Unknown'), 'error');
                    if (xhr.responseJSON?.[csrfName]) $('#csrf-token').val(xhr.responseJSON[csrfName]);
                }
            });
        });
    </script>
</body>
</html><!DOCTYPE html>
<html lang="en">
<head>
<?php $this->load->view('partials/title-meta'); ?>
<?php $this->load->view('partials/head-css'); ?>

<!-- External JS/CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<!-- QR Code: qrcode.js -->
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

<style>
.product-img { width: 50px; height: 50px; object-fit: cover; border-radius: 4px; cursor: pointer; }
.low-stock { color: #dc3545; font-weight: bold; }
.out-of-stock { color: #6c757d; font-weight: bold; }
.status-active { color: #28a745; }
.status-inactive { color: #dc3545; }
.variant-row { background-color: #f8f9fa !important; }
.variant-table td { padding: 0.5rem 0.75rem !important; }
.toggle-variants {
    cursor: pointer; width: 24px; height: 24px;
    display: inline-flex; align-items: center; justify-content: center;
    color: #6c757d; border-radius: 4px;
}
.toggle-variants:hover { color: #0d6efd; background-color: #e9ecef; }
.s-no { font-weight: 500; text-align: center; width: 5%; }
.no-expand { color: #adb5bd; }
.expand-icon { transition: transform 0.3s; }
.expanded { transform: rotate(90deg); }
.barcode-qr { display: flex; flex-direction: column; align-items: center; gap: 8px; }
.barcode-qr img { max-width: 100%; height: auto; }
.qr-canvas, .bar-canvas { width: 100% !important; }
/* Modal */
.modal-lg { max-width: 95%; }
.image-upload { border:2px dashed #ddd; border-radius:10px; padding:40px; text-align:center; cursor:pointer; transition:all .3s; }
.image-upload:hover { border-color:#007bff; background:#f8f9fa; }
.image-uploads i { font-size:48px; color:#007bff; margin-bottom:15px; }
.image-preview { display:flex; flex-wrap:wrap; gap:15px; margin-top:20px; }
.image-preview-item { position:relative; width:120px; height:120px; border-radius:8px; overflow:hidden; border:1px solid #ddd; }
.image-preview-item img { width:100%; height:100%; object-fit:cover; }
.btn-remove { position:absolute; top:5px; right:5px; width:30px; height:30px; border-radius:50%;
    background:#dc3545; color:white; border:none; cursor:pointer;
    display:flex; align-items:center; justify-content:center; opacity:.8; }
.btn-remove:hover { opacity:1; }
#modalBarcodePreview, #modalQrPreview { min-height:80px; display:flex; align-items:center; justify-content:center; }
.linkable { color: #0d6efd; text-decoration: underline; cursor: pointer; }
.linkable:hover { color: #0a58ca; }
</style>
</head>

<body>
<?php $this->load->view('partials/body'); ?>
<div class="main-wrapper">
<?php $this->load->view('partials/menu'); ?>
<div class="page-wrapper">
<div class="content">

<!-- Page Header -->
<div class="page-header">
    <div class="add-item d-flex">
        <div class="page-title">
            <h4>Products List</h4>
            <h6>Manage products, variants & stock</h6>
        </div>
    </div>
    <ul class="table-top-head">
        <li>
            <div class="page-btn">
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addProductModal">
                    <i data-feather="plus" class="me-2"></i>Add New Product
                </button>
            </div>
        </li>
    </ul>
</div>

<!-- Stats Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card stats-card text-center shadow-sm">
            <div class="card-body">
                <h6 class="text-muted">Total Products</h6>
                <h3><?php echo $stats['total'] ?? 0; ?></h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stats-card text-center shadow-sm border-warning">
            <div class="card-body">
                <h6 class="text-warning">Low Stock</h6>
                <h3 class="text-warning"><?php echo $stats['low_stock'] ?? 0; ?></h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stats-card text-center shadow-sm border-danger">
            <div class="card-body">
                <h6 class="text-danger">Out of Stock</h6>
                <h3 class="text-danger"><?php echo $stats['out_of_stock'] ?? 0; ?></h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stats-card text-center shadow-sm border-info">
            <div class="card-body">
                <h6 class="text-info">Total Variants</h6>
                <h3 class="text-info"><?php echo $stats['total_variants'] ?? 0; ?></h3>
            </div>
        </div>
    </div>
</div>

<!-- Alerts -->
<?php if($this->session->flashdata('success')): ?>
<div class="alert alert-success alert-dismissible fade show">
    <?php echo $this->session->flashdata('success'); ?>
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
<?php endif; ?>
<?php if($this->session->flashdata('error')): ?>
<div class="alert alert-danger alert-dismissible fade show">
    <?php echo $this->session->flashdata('error'); ?>
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
<?php endif; ?>

<!-- Search -->
<div class="card mb-4">
    <div class="card-body">
        <form method="get" action="<?php echo base_url('products-list'); ?>">
            <div class="row g-3">
                <div class="col-md-8">
                    <div class="input-group">
                        <input type="text" class="form-control" name="search"
                            placeholder="Search by name, barcode, item code..."
                            value="<?php echo htmlspecialchars($search ?? ''); ?>">
                        <button class="btn btn-primary" type="submit">
                            <i data-feather="search"></i> Search
                        </button>
                        <?php if(!empty($search)): ?>
                        <a href="<?php echo base_url('products-list'); ?>" class="btn btn-secondary">Clear</a>
                        <?php endif; ?>
                    </div>
                </div>
                <div class="col-md-4 text-end">
                    <span class="text-muted">Showing: 
                        <?php echo count($products); ?> of <?php echo $stats['total'] ?? 0; ?> products
                    </span>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Products Table -->
<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover table-bordered align-middle">
                <thead class="table-dark">
                    <tr>
                        <th width="5%" class="text-center">S.No</th>
                        <th width="4%" class="text-center">V</th>
                        <th width="8%">Image</th>
                        <th>Product Name</th>
                        <th>Barcode & QR</th>
                        <th>Category → Sub</th>
                        <th>Brand / Supplier</th>
                        <th width="10%">Stock</th>
                        <th width="10%">Status</th>
                        <th width="12%">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <?php if(empty($products)): ?>
                    <tr><td colspan="10" class="text-center py-4">No products found.</td></tr>
                    <?php else:
                        $base = $this->uri->segment(3) ? ($this->uri->segment(3) - 1) * $this->config->item('per_page') : 0;
                        $sno = $base + 1;
                        foreach($products as $product): ?>
                    <tr>
                        <td class="text-center s-no"><?php echo $sno++; ?></td>
                        <td class="text-center">
                            <?php if (!empty($product->variants)): ?>
                            <span class="toggle-variants" data-product-id="<?php echo $product->id; ?>"
                                title="View <?php echo count($product->variants); ?> variant(s)">
                                <i data-feather="chevron-right" class="expand-icon"></i>
                            </span>
                            <?php else: ?>
                            <span class="no-expand" title="No variants">—</span>
                            <?php endif; ?>
                        </td>
                        <td class="text-center">
                            <?php
                            $img_path = !empty($product->primary_image)
                                ? base_url("uploads/products/{$product->id}/{$product->primary_image}")
                                : base_url('assets/img/default-product.png');
                            ?>
                            <img src="<?php echo $img_path; ?>" class="product-img"
                                onerror="this.src='<?php echo base_url('assets/img/default-product.png'); ?>'">
                        </td>
                        <td>
                            <strong><?php echo htmlspecialchars($product->name); ?></strong><br>
                            <small class="text-muted">#<?php echo htmlspecialchars($product->item_code ?: 'N/A'); ?></small>
                        </td>
                        <td class="barcode-qr">
                            <div class="bar-canvas" id="barcode-<?php echo $product->id; ?>"></div>
                            <div class="qr-canvas" id="qr-<?php echo $product->id; ?>"></div>
                            <small class="text-muted"><?php echo htmlspecialchars($product->barcode); ?></small>
                        </td>
                        <td>
                            <?php if(!empty($product->category_name)): ?>
                                <a href="<?php echo base_url('categories'); ?>" class="linkable">
                                    <?php echo htmlspecialchars($product->category_name); ?>
                                </a>
                                <?php if(!empty($product->sub_category_name)): ?>
                                <br>
                                <small>→ <a href="<?php echo base_url('sub-categories'); ?>" class="linkable">
                                    <?php echo htmlspecialchars($product->sub_category_name); ?>
                                </a></small>
                                <?php endif; ?>
                            <?php else: ?>
                                <span class="text-muted">—</span>
                            <?php endif; ?>
                        </td>
                        <td>
                            <?php if(!empty($product->brand_name)): ?>
                                <a href="<?php echo base_url('brands'); ?>" class="linkable">
                                    <?php echo htmlspecialchars($product->brand_name); ?>
                                </a>
                            <?php else: ?>
                                <span class="text-muted">—</span>
                            <?php endif; ?>
                            <br>
                            <small>
                                <?php if(!empty($product->supplier_name)): ?>
                                <a href="<?php echo base_url('suppliers'); ?>" class="linkable">
                                    <?php echo htmlspecialchars($product->supplier_name); ?>
                                </a>
                                <?php endif; ?>
                            </small>
                        </td>
                        <td class="text-center">
                            <?php $total_stock = $product->total_stock ?? 0; ?>
                            <?php if($total_stock == 0): ?>
                                <span class="out-of-stock">Out</span>
                            <?php elseif($total_stock <= ($product->alert_quantity ?? 5)): ?>
                                <span class="low-stock"><?php echo $total_stock; ?> Low</span>
                            <?php else: ?>
                                <span class="text-success"><?php echo $total_stock; ?></span>
                            <?php endif; ?>
                        </td>
                        <td class="text-center">
                            <?php if($product->status == 1): ?>
                                <span class="status-active">Active</span>
                            <?php else: ?>
                                <span class="status-inactive">Inactive</span>
                            <?php endif; ?>
                        </td>
                        <td class="text-center">
                            <div class="d-flex justify-content-center gap-1">
                                <button type="button" class="btn btn-info btn-sm view-btn" 
                                    data-id="<?php echo $product->id; ?>" title="View">
                                    <i data-feather="eye"></i>
                                </button>
                                <button type="button" class="btn btn-warning btn-sm edit-btn" 
                                    data-id="<?php echo $product->id; ?>" title="Edit">
                                    <i data-feather="edit-2"></i>
                                </button>
                                <button type="button" class="btn btn-danger btn-sm delete-btn" 
                                    data-id="<?php echo $product->id; ?>" title="Delete">
                                    <i data-feather="trash-2"></i>
                                </button>
                            </div>
                        </td>
                    </tr>

                    <!-- Variant Row (Hidden) -->
                    <?php if (!empty($product->variants)): ?>
                    <tr class="variant-row d-none" id="variants-<?php echo $product->id; ?>">
                        <td colspan="10" class="p-0">
                            <div class="px-3 py-2 bg-light">
                                <h6 class="mb-3">
                                    <i data-feather="layers" class="me-1"></i>
                                    Variants for <strong>"<?php echo htmlspecialchars($product->name); ?>"</strong>
                                    <span class="badge bg-primary ms-2"><?php echo count($product->variants); ?> variants</span>
                                </h6>
                                <div class="table-responsive">
                                    <table class="table table-sm variant-table">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Unit</th>
                                                <th>Volume</th>
                                                <th>Purchase Price</th>
                                                <th>Selling Price</th>
                                                <th>Discount</th>
                                                <th>Stock</th>
                                                <th>Status</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <?php foreach($product->variants as $v): ?>
                                            <tr>
                                                <td>
                                                    <span class="badge badge-variant bg-secondary">
                                                        <?php echo htmlspecialchars($v->unit_name); ?>
                                                    </span>
                                                    <?php if(!empty($v->volume) && $v->volume != 1): ?>
                                                    <br><small><?php echo $v->volume; ?>x</small>
                                                    <?php endif; ?>
                                                </td>
                                                <td><?php echo $v->volume ?? 1; ?></td>
                                                <td>₹<?php echo number_format($v->purchase_price, 2); ?></td>
                                                <td>₹<?php echo number_format($v->selling_price, 2); ?></td>
                                                <td>
                                                    <?php $disc = $v->discount ?? 0;
                                                    if($disc > 0): ?>
                                                    <span class="text-success">₹<?php echo number_format($disc, 2); ?></span>
                                                    <?php else: ?>
                                                    <span class="text-muted">—</span>
                                                    <?php endif; ?>
                                                </td>
                                                <td>
                                                    <?php if($v->stock == 0): ?>
                                                        <span class="out-of-stock">Out</span>
                                                    <?php elseif($v->stock <= $v->alert_stock): ?>
                                                        <span class="low-stock"><?php echo $v->stock; ?></span>
                                                    <?php else: ?>
                                                        <span class="text-success"><?php echo $v->stock; ?></span>
                                                    <?php endif; ?>
                                                </td>
                                                <td><?php echo $v->status ? '✓' : '✗'; ?></td>
                                            </tr>
                                            <?php endforeach; ?>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </td>
                    </tr>
                    <?php endif; ?>
                    <?php endforeach; endif; ?>
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        <?php if(isset($links)): ?>
        <div class="mt-3 d-flex justify-content-center">
            <?php echo $links; ?>
        </div>
        <?php endif; ?>
    </div>
</div>

</div>
</div>
</div>

<!-- ========== ADD PRODUCT MODAL ========== -->
<div class="modal fade" id="addProductModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Product</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="addProductForm" enctype="multipart/form-data">
                <input type="hidden" name="<?= $this->security->get_csrf_token_name(); ?>" 
                       value="<?= $this->security->get_csrf_hash(); ?>" id="csrf-token">
                <div class="modal-body">
                    <!-- Product Info -->
                    <div class="card mb-3">
                        <div class="card-header"><h6>Product Information</h6></div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <label>Product Name *</label>
                                    <input type="text" name="name" class="form-control" required maxlength="255">
                                </div>
                                <div class="col-md-3">
                                    <label>Item Code</label>
                                    <input type="text" name="item_code" class="form-control" placeholder="e.g. P-1001">
                                </div>
                                <div class="col-md-3">
                                    <label>EAN-13 Barcode *</label>
                                    <div class="input-group">
                                        <input type="text" name="barcode" class="form-control" pattern="\d{13}" maxlength="13" id="modalBarcodeInput">
                                        <button type="button" class="btn btn-outline-primary" onclick="generateModalBarcode()">Generate</button>
                                    </div>
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-md-12 barcode-qr" style="margin-top:10px">
                                    <label>Barcode & QR Preview</label>
                                    <div class="d-flex justify-content-around mt-2">
                                        <div class="text-center">
                                            <div id="modalBarcodePreview"></div>
                                            <small>EAN-13</small>
                                        </div>
                                        <div class="text-center">
                                            <div id="modalQrPreview"></div>
                                            <small>QR Code</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-md-4">
                                    <label>Category *</label>
                                    <select class="form-control select2" name="category_id" id="modalCategorySelect" required>
                                        <option value="">Choose Category</option>
                                        <?php foreach($categories as $c): ?>
                                        <option value="<?php echo $c->id ?>"><?php echo $c->name ?></option>
                                        <?php endforeach; ?>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label>Sub Category</label>
                                    <select class="form-control select2" name="sub_category_id" id="modalSubCategorySelect">
                                        <option value="">Choose Sub Category</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label>Brand</label>
                                    <select class="form-control select2" name="brand_id">
                                        <option value="">Choose Brand</option>
                                        <?php foreach($brands as $b): ?>
                                        <option value="<?php echo $b->id ?>"><?php echo $b->name ?></option>
                                        <?php endforeach; ?>
                                    </select>
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-md-6">
                                    <label>Supplier</label>
                                    <select class="form-control select2" name="supplier_id">
                                        <option value="">Choose Supplier</option>
                                        <?php foreach($suppliers as $s): ?>
                                        <option value="<?php echo $s->id ?>"><?php echo $s->name ?></option>
                                        <?php endforeach; ?>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label>Short Description</label>
                                    <textarea name="short_description" class="form-control" rows="2"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Variants -->
                    <div class="card mb-3">
                        <div class="card-header"><h6>Pricing & Variants</h6></div>
                        <div class="card-body">
                            <button type="button" class="btn btn-success" onclick="addModalRow()">
                                <i data-feather="plus"></i> Add Variant
                            </button>
                            <table class="table table-bordered mt-2" id="modalPricingTable">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Unit</th>
                                        <th>Volume</th>
                                        <th>Purchase Price</th>
                                        <th>Selling Price</th>
                                        <th>Discount</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Images -->
                    <div class="card mb-3">
                        <div class="card-header"><h6>Product Images</h6></div>
                        <div class="card-body">
                            <div class="image-upload" onclick="document.getElementById('modalImageUpload').click()">
                                <input type="file" id="modalImageUpload" name="images[]" multiple accept="image/*" style="display:none;" onchange="previewModalImages(this)">
                                <div class="image-uploads"><i class="fa fa-plus-circle"></i><h6>Click to upload images</h6></div>
                            </div>
                            <div class="image-preview" id="modalImagePreview"></div>
                        </div>
                    </div>

                    <!-- Status -->
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" name="status" value="1" checked>
                        <label class="form-check-label">Active</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Product</button>
                </div>
            </form>
        </div>
    </div>
</div>

<?php $this->load->view('partials/theme-settings'); ?>
<?php $this->load->view('partials/vendor-scripts'); ?>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
let modalUnits = <?php echo json_encode($units); ?>;
let csrfName = '<?php echo $this->security->get_csrf_token_name(); ?>';

$(document).ready(function() {
    $('.select2').select2({ width: '100%' });
    feather.replace();

    // Toggle variants
    $('.toggle-variants').on('click', function() {
        const icon = $(this).find('i.expand-icon');
        const id = $(this).data('product-id');
        const row = $('#variants-' + id);
        icon.toggleClass('expanded');
        row.toggleClass('d-none');
        // Generate barcode/QR only once
        if (!icon.hasClass('generated')) {
            generateBarcodeFor(id);
            generateQrFor(id);
            icon.addClass('generated');
        }
    });

    // Category → SubCategory
    $('#modalCategorySelect').on('change', function() {
        const catId = $(this).val();
        if (!catId) {
            $('#modalSubCategorySelect').html('<option value="">Choose Sub Category</option>');
            return;
        }
        $.post('<?php echo base_url("home/products_get_sub_categories"); ?>', {
            category_id: catId,
            [csrfName]: $('#csrf-token').val()
        }, function(res) {
            let opts = '<option value="">Choose Sub Category</option>';
            if (res.status === 'success') {
                res.data.forEach(c => opts += `<option value="${c.id}">${c.name}</option>`);
            }
            $('#modalSubCategorySelect').html(opts);
            $('#csrf-token').val(res[csrfName]);
        }, 'json').fail(() => Swal.fire('Error', 'Failed to load subcategories', 'error'));
    });

    // Add first row
    if ($('#modalPricingTable tbody').length === 0) addModalRow();

    // Generate all barcodes/QR on load for visible products
    $('.toggle-variants').each(function() {
        const id = $(this).data('product-id');
        generateBarcodeFor(id);
        generateQrFor(id);
    });
});

// === BARCODE & QR (Shared) ===
function generateBarcodeFor(id) {
    const code = $('#barcode-' + id).closest('tr').find('small').text();
    if (!code) return;
    JsBarcode(`#barcode-${id}`, code, {
        format: "EAN13", width: 1.5, height: 40,
        displayValue: true, fontSize: 14,
        textMargin: 5
    });
}

function generateQrFor(id) {
    const code = $('#qr-' + id).closest('tr').find('small').text();
    if (!code) return;
    $('#qr-' + id).empty();
    QRCode.toCanvas(document.getElementById(`qr-${id}`), code, {
        width: 80, height: 80, margin: 2
    }, function (error) {
        if (error) console.error(error);
    });
}

// === MODAL BARCODE & QR ===
function generateModalBarcode() {
    const firstTwo = Math.floor(Math.random() * 90) + 10;
    const nextTen = Math.floor(Math.random() * 1e10).toString().padStart(10, '0');
    const base = firstTwo + nextTen;
    const check = calculateEAN13CheckDigit(base);
    const code = base + check;
    $('#modalBarcodeInput').val(code);
    updateModalBarcodePreview();
}

function calculateEAN13CheckDigit(code) {
    let sum = 0;
    for (let i = 0; i < 12; i++) {
        const d = parseInt(code[i]);
        sum += (i % 2 === 0) ? d : d * 3;
    }
    const r = sum % 10;
    return r === 0 ? 0 : 10 - r;
}

function updateModalBarcodePreview() {
    const code = $('#modalBarcodeInput').val().trim();
    const $bar = $('#modalBarcodePreview');
    const $qr = $('#modalQrPreview');

    if (!/^\d{13}$/.test(code)) {
        $bar.html('<small class="text-muted">Enter 13-digit barcode</small>');
        $qr.html('');
        return;
    }

    // Barcode
    $bar.empty();
    const barCanvas = document.createElement('canvas');
    barCanvas.id = 'tempBar';
    $bar.append(barCanvas);
    JsBarcode('#tempBar', code, {
        format: "EAN13", width: 2, height: 60,
        displayValue: true, fontSize: 12
    });

    // QR
    $qr.empty();
    QRCode.toCanvas($qr[0], code, { width: 80, height: 80, margin: 1 }, function() {});
}

$('#modalBarcodeInput').on('input', updateModalBarcodePreview);

// === MODAL PRICING ===
function addModalRow() {
    const tbody = document.querySelector('#modalPricingTable tbody');
    const i = tbody.rows.length;
    let opts = '<option value="">Select Unit</option>';
    modalUnits.forEach(u => opts += `<option value="${u.id}">${u.name} (${u.symbol})</option>`);
    const tr = document.createElement('tr');
    tr.innerHTML = `
        <td><select name="pricing[${i}][unit_id]" class="form-control" required>${opts}</select></td>
        <td><input type="number" name="pricing[${i}][volume]" class="form-control volume" value="1" min="0.001" step="0.001"></td>
        <td><input type="number" name="pricing[${i}][purchase_price]" class="form-control purchase" value="0" step="0.01"></td>
        <td><input type="number" name="pricing[${i}][selling_price]" class="form-control selling" value="0" step="0.01"></td>
        <td><input type="number" name="pricing[${i}][discount]" class="form-control discount" value="0" step="0.01" readonly></td>
        <td class="text-center"><button type="button" class="btn btn-danger btn-sm" onclick="removeModalRow(this)"><i data-feather="trash-2"></i></button></td>
    `;
    tbody.appendChild(tr);
    feather.replace();
    tr.querySelectorAll('.volume,.purchase,.selling').forEach(el =>
        el.addEventListener('input', () => autoCalculateModal(tr))
    );
}

function autoCalculateModal(row) {
    const rows = document.querySelectorAll('#modalPricingTable tbody tr');
    if (rows.length === 0) return;
    const base = rows[0];
    const baseVol = parseFloat(base.querySelector('.volume').value) || 1;
    const basePur = parseFloat(base.querySelector('.purchase').value) || 0;
    const baseSel = parseFloat(base.querySelector('.selling').value) || 0;
    rows.forEach(r => {
        const vol = parseFloat(r.querySelector('.volume').value) || 1;
        const ratio = vol / baseVol;
        const purInput = r.querySelector('.purchase');
        const selInput = r.querySelector('.selling');
        const disInput = r.querySelector('.discount');
        purInput.value = (basePur * ratio).toFixed(2);
        selInput.value = (baseSel * ratio).toFixed(2);
        const discount = (parseFloat(purInput.value) - parseFloat(selInput.value)).toFixed(2);
        disInput.value = discount > 0 ? discount : '0.00';
    });
}

function removeModalRow(btn) {
    if (document.querySelectorAll('#modalPricingTable tbody tr').length > 1) {
        btn.closest('tr').remove();
    } else {
        Swal.fire('Warning', 'At least one variant is required.', 'warning');
    }
}

// === IMAGE PREVIEW ===
function previewModalImages(input) {
    const preview = document.getElementById('modalImagePreview');
    if (!input.files.length) return;
    Array.from(input.files).forEach(file => {
        if (file.size > 2 * 1024 * 1024) {
            Swal.fire('Warning', 'Image too large (>2MB): ' + file.name, 'warning');
            return;
        }
        const reader = new FileReader();
        reader.onload = e => {
            const div = document.createElement('div');
            div.className = 'image-preview-item';
            div.innerHTML = `
                <img src="${e.target.result}">
                <button type="button" class="btn-remove" onclick="this.parentElement.remove()"><i data-feather="x"></i></button>
            `;
            preview.appendChild(div);
            feather.replace();
        };
        reader.readAsDataURL(file);
    });
}

// === FORM SUBMIT (AJAX) ===
$('#addProductForm').on('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);

    Swal.fire({
        title: 'Saving...',
        text: 'Please wait',
        allowEscapeKey: false,
        allowOutsideClick: false,
        didOpen: () => Swal.showLoading()
    });

    $.ajax({
        url: '<?php echo base_url("home/add_product"); ?>',
        method: 'POST',
        data: formData,
        contentType: false,
        processData: false,
        dataType: 'json',
        success: function(res) {
            Swal.close();
            if (res.status === 'success') {
                Swal.fire('Success', res.message, 'success').then(() => {
                    $('#addProductModal').modal('hide');
                    window.location.reload();
                });
            } else {
                Swal.fire('Error', res.message || 'Validation failed', 'error');
                $('#csrf-token').val(res[csrfName] || $('#csrf-token').val());
            }
        },
        error: function(xhr) {
            Swal.close();
            const msg = xhr.responseJSON?.message || 'An unknown error occurred';
            Swal.fire('Error', msg, 'error');
            if (xhr.responseJSON?.[csrfName]) $('#csrf-token').val(xhr.responseJSON[csrfName]);
        }
    });
});
</script>
</body>
</html>